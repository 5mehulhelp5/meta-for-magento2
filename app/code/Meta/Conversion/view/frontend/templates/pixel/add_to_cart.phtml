<?php /** @var \Meta\Conversion\Block\Pixel\AddToCart $block */ ?>
<?php if ($block->getFacebookPixelID()) { ?>
    <script>
        require([
            'jquery'
        ], function ($) {

            function trackAddToCart(content_ids, content_name, content_category, value, eventId) {
                fbq('set', 'agent', '<?= /* @noEscape */ $ $block->getFacebookAgentVersion() ?>', '<?= /* @noEscape */ $block->getFacebookPixelID() ?>');
                fbq('track', 'AddToCart', {
                        source: "<?= /* @noEscape */ $block->getSource() ?>",
                        pluginVersion: "<?= /* @noEscape */ $block->getPluginVersion() ?>",
                        content_type: "<?= /* @noEscape */ $block->getContentType() ?>",
                        currency: "<?= /* @noEscape */ $block->getCurrency() ?>",
                        content_ids: content_ids,
                        content_name: content_name,
                        content_category: content_category,
                        value: value
                    },
                    {
                        eventID: eventId
                    }
                );
            }

            var product_info_url = '<?= /* @noEscape */ $block->getProductInfoUrl() ?>';

            $(document).on('ajax:addToCart', function (event, data) {
                var configurableProduct = data.form.data().mageConfigurable;
                if(configurableProduct) {
                    var simpleProductId = configurableProduct.simpleProduct;
                }
                var product_sku = data.sku;
                var form_key = jQuery("[name='form_key']").val();
                $.ajax({
                    url: product_info_url,
                    data: {
                        product_sku: product_sku,
                        product_id: simpleProductId,
                        form_key: form_key
                    },
                    type: 'post',
                    dataType: 'json',
                    success: function (res) {
                        trackAddToCart(
                            [res.id],
                            res.name,
                            res.content_category,
                            res.value,
                            res.event_id
                        );
                    }
                });
            });
        });
    </script>
<?php } ?>
