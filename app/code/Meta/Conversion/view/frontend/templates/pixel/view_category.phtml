<?php
/** @var \Meta\Conversion\Block\Pixel\ViewCategory $block */

$trackerUrl = $block->getTrackerUrl();
?>

<!-- Added the new component below to track server events -->
<script type="text/x-magento-init">
    {
        "*": {
            "Meta_Conversion/js/metaPixelTracker" : {
                "url" : "<?= $block->escapeJs($trackerUrl); ?>",
                "payload": <?= json_encode([
                    "eventName" => $block->getEventToObserveName(),
                    "categoryId" => $block->getCategoryId()
                ]) ?>
            }
        }
    }
</script>

<?php
if ($block->getFacebookPixelID()) {
    /**
     * @var \Meta\Conversion\Block\Pixel\ViewCategory $block
     * @var \Magento\Framework\Escaper $escaper
     */
    $categoryName = $block->getCategoryName();
    ?>
    <script>
        fbq('set', 'agent', '<?= $block->getFacebookAgentVersion() ?>', '<?= $block->getFacebookPixelID() ?>');
        fbq('trackCustom', 'ViewCategory', {
                source: "<?= $block->getSource() ?>",
                pluginVersion: "<?= $block->getPluginVersion() ?>"
                <?php if ($block->getCategoryName()) { ?>
                , content_category: "<?= $escaper->escapeHtmlAttr($categoryName) ?>"
                <?php } ?>
            }
            , {
                eventID: "<?= $block->getEventId() ?>"
            }
        );
    </script>
    <?php $block->logEvent($block->getFacebookPixelID(), 'ViewCategory') ?>
<?php } ?>
